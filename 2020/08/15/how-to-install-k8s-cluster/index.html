	<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="B6QNJ8N2Q7hbnMncyrM5GMCWgK-vIAEx0o2DQre64ls">
  
  <title>how to install k8s cluster | t1ger的茶馆</title>
  <meta name="author" content="t1ger">
  
  <meta name="description" content="https://t1ger.github.io/">
  

  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta property="og:title" content="how to install k8s cluster">
  <meta property="og:site_name" content="t1ger的茶馆">

  
  
		<!-- favicon -->
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.png">
		<meta name="theme-color" content="#009688">
		<!-- favicon end -->
    <!-- <link href="/favicon.ico" rel="icon"> -->
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  

  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>
</html>
 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">t1ger的茶馆</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
                <li>
                    <a href="/about" title="">
                    <i class="fa fa-info-circle"></i>关于
                    </a>
                </li>
                
                <li>
                    <a href="/atom.xml" title="这是一个订阅源">
                    <i class="fa fa-rss"></i>RSS
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	
	<div class="col-md-9 center-content">
	

		<div class="content">
			<!-- index -->
		   

			  		<h2>how to install k8s cluster</h2>
					
					<div>
						<span class="post-time">2020-08-15 17:58:55</span>
					</div>	
					

					<div class="article-content">
						<h5 id="环境和版本说明"><a href="#环境和版本说明" class="headerlink" title="环境和版本说明"></a>环境和版本说明</h5><p>系统： CentOS Linux release 7.8.2003 (Core)<br>etcd: etcd-v3.4.7<br>k8s:  v1.18.6<br>Calico: v3.15.1<br>docker: docker-ce-19.03<br>负载均衡生产一般建议采用阿里云slb，测试环境可以使用nginx代替<br>service-cluster-ip 10.10.0.0/16<br>pods-ip 10.20.0.0/16<br>集群dns  10.10.0.2<br>k8s svc 10.10.0.1<br>集群使用默认 svc.cluster.local<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.10.0.1    &lt;none&gt;        443/TCP   33h</span><br></pre></td></tr></table></figure></p>
<p>master和etcd在同一台主机上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">master01   192.168.1.101    kube-apiserver kube-controller-manager kube-scheduler</span><br><span class="line">master02   192.168.1.102    kube-apiserver kube-controller-manager kube-scheduler</span><br><span class="line">master03   192.168.1.103    kube-apiserver kube-controller-manager kube-scheduler</span><br><span class="line">slb   　　　192.168.1.31     nginx</span><br><span class="line">node1      192.168.1.104    kubelet kube-proxy  calico</span><br><span class="line">node2      192.168.1.105    kubelet kube-proxy  calico</span><br><span class="line">node3      192.168.1.106    kubelet kube-proxy  calico</span><br></pre></td></tr></table></figure></p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>升级内核<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line">#查看可用内核</span><br><span class="line">cat /boot/grub2/grub.cfg |grep menuentry</span><br><span class="line">#设置开机从新内核启动</span><br><span class="line">grub2-set-default &quot;CentOS Linux (4.4.232-1.el7.elrepo.x86_64) 7 (Core)&quot;</span><br><span class="line">#查看内核启动项</span><br><span class="line">grub2-editenv list</span><br><span class="line">#重启系统使内核生效</span><br><span class="line">reboot</span><br><span class="line">#查看内核版本是否生效</span><br><span class="line">uname -r</span><br></pre></td></tr></table></figure></p>
<p>初始化系统<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">swapoff -a </span><br><span class="line">sed -i &apos;s/.*swap.*/#&amp;/&apos; /etc/fstab</span><br><span class="line">setenforce  0 </span><br><span class="line">sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/sysconfig/selinux </span><br><span class="line">sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br><span class="line">sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/sysconfig/selinux</span><br><span class="line">sed -i &quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot; /etc/selinux/config</span><br><span class="line"></span><br><span class="line"># 将桥接的IPv4流量传递到iptables的链</span><br><span class="line">cat&gt;/etc/sysctl.d/k8s.conf&lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1１</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=１</span><br><span class="line">net.ipv6.conf.default.disable_ipv6=1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6=1</span><br><span class="line">net.ipv6.conf.all.forwarding=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line">sysctl --system  # 生效</span><br><span class="line"></span><br><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install -y docker-ce docker-ce-cli containerd.io</span><br><span class="line">systemctl enable docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure></p>
<h5 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h5><p>在部署之前先自签证书，参考上一篇<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/etcd/ -p</span><br><span class="line">mkdir /opt/kubernetes/&#123;bin,cfg,ssl&#125;  -p</span><br><span class="line">cd /data/etcd/</span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.4.7/etcd-v3.4.7-linux-amd64.tar.gz</span><br><span class="line">tar zxvf etcd-v3.4.7-linux-amd64.tar.gz</span><br><span class="line">cd etcd-v3.4.7-linux-amd64</span><br><span class="line">cp -a etcd etcdctl /opt/kubernetes/bin/</span><br><span class="line">echo &apos;export PATH=$PATH:/opt/kubernetes/bin&apos; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>分发证书，并依次在master01,master02,master03执行,并注意替换相应ip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 etcd]# cat etcd.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">ETCD_NAME=$&#123;1:-&quot;etcd01&quot;&#125;</span><br><span class="line">ETCD_IP=$&#123;2:-&quot;127.0.0.1&quot;&#125;</span><br><span class="line">ETCD_CLUSTER=$&#123;3:-&quot;etcd01=https://127.0.0.1:2379&quot;&#125;</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/etcd.yml</span><br><span class="line">name: $&#123;ETCD_NAME&#125;</span><br><span class="line">data-dir: /var/lib/etcd/default.etcd</span><br><span class="line">listen-peer-urls: https://$&#123;ETCD_IP&#125;:2380</span><br><span class="line">listen-client-urls: https://$&#123;ETCD_IP&#125;:2379,https://127.0.0.1:2379</span><br><span class="line">advertise-client-urls: https://$&#123;ETCD_IP&#125;:2379</span><br><span class="line">initial-advertise-peer-urls: https://$&#123;ETCD_IP&#125;:2380</span><br><span class="line">initial-cluster: $&#123;ETCD_CLUSTER&#125;</span><br><span class="line">initial-cluster-token: etcd-cluster</span><br><span class="line">initial-cluster-state: new</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: /opt/kubernetes/ssl/server.pem</span><br><span class="line">  key-file: /opt/kubernetes/ssl/server-key.pem</span><br><span class="line">  client-cert-auth: false</span><br><span class="line">  trusted-ca-file: /opt/kubernetes/ssl/ca.pem</span><br><span class="line">  auto-tls: false</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: /opt/kubernetes/ssl/server.pem</span><br><span class="line">  key-file: /opt/kubernetes/ssl/server-key.pem</span><br><span class="line">  client-cert-auth: false</span><br><span class="line">  trusted-ca-file: /opt/kubernetes/ssl/ca.pem</span><br><span class="line">  auto-tls: false</span><br><span class="line">debug: false</span><br><span class="line">logger: zap</span><br><span class="line">log-outputs: [stderr]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">Documentation=https://github.com/etcd-io/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/opt/kubernetes/bin/etcd --config-file=/opt/kubernetes/cfg/etcd.yml</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable etcd</span><br><span class="line">systemctl restart etcd</span><br><span class="line"></span><br><span class="line">#master01</span><br><span class="line">./etcd.sh etcd01 192.168.1.101 etcd01=https://192.168.1.101:2380,etcd02=https://192.168.1.102:2380,etcd03=https://192.168.1.103:2380</span><br><span class="line"></span><br><span class="line">#master02</span><br><span class="line">./etcd.sh etcd02 192.168.1.102 etcd01=https://192.168.1.101:2380,etcd02=https://192.168.1.102:2380,etcd03=https://192.168.1.103:2380</span><br><span class="line"></span><br><span class="line">#master03</span><br><span class="line">./etcd.sh etcd03 192.168.1.103 etcd01=https://192.168.1.101:2380,etcd02=https://192.168.1.102:2380,etcd03=https://192.168.1.103:2380</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#健康状态</span><br><span class="line">[root@master01 etcd]# /opt/kubernetes/bin/etcdctl --cacert=/opt/kubernetes/ssl/ca.pem --cert=/opt/kubernetes/ssl/server.pem --key=/opt/kubernetes/ssl/server-key.pem --endpoints=https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 endpoint status</span><br><span class="line">https://192.168.1.101:2379, f592173020929e13, 3.4.7, 1.8 MB, false, false, 19, 53478, 53478, </span><br><span class="line">https://192.168.1.102:2379, 4eb9518f73eaf60f, 3.4.7, 1.8 MB, false, false, 19, 53478, 53478, </span><br><span class="line">https://192.168.1.103:2379, 2123e126fcaeb456, 3.4.7, 1.8 MB, true, false, 19, 53478, 53478, </span><br><span class="line"></span><br><span class="line">＃写入foo</span><br><span class="line">/opt/kubernetes/bin/etcdctl --cacert=/opt/kubernetes/ssl/ca.pem --cert=/opt/kubernetes/ssl/server.pem --key=/opt/kubernetes/ssl/server-key.pem --endpoints=https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 put foo &quot;Hello World&quot;</span><br><span class="line">#取出foo</span><br><span class="line">[root@master02 ~]# /opt/kubernetes/bin/etcdctl --cacert=/opt/kubernetes/ssl/ca.pem --cert=/opt/kubernetes/ssl/server.pem --key=/opt/kubernetes/ssl/server-key.pem --endpoints=https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 get foo</span><br><span class="line">foo</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure></p>
<h5 id="k8s安装"><a href="#k8s安装" class="headerlink" title="k8s安装"></a>k8s安装</h5><p>K8S二进制包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/k8s-package</span><br><span class="line">cd /data/k8s-package</span><br><span class="line">wget https://dl.k8s.io/v1.18.6/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar xf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd /data/k8s-package/kubernetes/server/bin</span><br><span class="line">cp -a kube-apiserver kube-controller-manager kube-scheduler kubectl kubelet kube-proxy /opt/kubernetes/bin</span><br><span class="line"></span><br><span class="line"># copy 执行文件到 master02 master03 机器 /opt/kubernetes/bin</span><br><span class="line">scp kube-apiserver kube-controller-manager kube-scheduler kubectl kubelet kube-proxy root@master02:/opt/kubernetes/bin/</span><br><span class="line">scp kube-apiserver kube-controller-manager kube-scheduler kubectl kubelet kube-proxy root@master03:/opt/kubernetes/bin/</span><br></pre></td></tr></table></figure></p>
<p>创建Node节点kubeconfig文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# cat /data/ssl/kubeconfig.sh </span><br><span class="line">export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d &apos; &apos;)</span><br><span class="line">cat&gt;token.csv&lt;&lt;EOF</span><br><span class="line">$&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">export KUBE_APISERVER=&quot;https://lb.abc.com.cn:6443&quot;</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl -n kube-system create serviceaccount kube-proxy</span><br><span class="line">kubectl create clusterrolebinding system:kube-proxy --clusterrole system:node-proxier --serviceaccount kube-system:kube-proxy</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">#sh kubeconfig.sh</span><br><span class="line">#cp *kubeconfig /opt/kubernetes/cfg</span><br><span class="line">#scp *kubeconfig root@master02:/opt/kubernetes/cfg</span><br><span class="line">#scp *kubeconfig root@master03:/opt/kubernetes/cfg</span><br></pre></td></tr></table></figure></p>
<p>配置master组件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/k8s-master</span><br><span class="line">[root@master01 k8s-master]# cat apiserver.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">MASTER_ADDRESS=$&#123;1:-&quot;192.168.1.101&quot;&#125;</span><br><span class="line">ETCD_SERVERS=$&#123;2:-&quot;https://127.0.0.1:2379&quot;&#125;</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/var/log/kubernetes \\</span><br><span class="line">--etcd-servers=$&#123;ETCD_SERVERS&#125; \\</span><br><span class="line">--bind-address=0.0.0.0 \\</span><br><span class="line">--secure-port=6443 \\</span><br><span class="line">--advertise-address=$&#123;MASTER_ADDRESS&#125; \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--service-cluster-ip-range=10.10.0.0/16 \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction \\</span><br><span class="line">--authorization-mode=Node,RBAC \\</span><br><span class="line">--kubelet-https=true \\</span><br><span class="line">--enable-bootstrap-token-auth=true \\</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span><br><span class="line">--service-node-port-range=30000-50000 \\</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--etcd-cafile=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--etcd-certfile=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--etcd-keyfile=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \\</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">--requestheader-username-headers=X-Remote-User \\</span><br><span class="line">--proxy-client-cert-file=/opt/kubernetes/ssl/metrics-server.pem \\</span><br><span class="line">--proxy-client-key-file=/opt/kubernetes/ssl/metrics-server-key.pem \\</span><br><span class="line">--runtime-config=api/all=true \\</span><br><span class="line">--audit-log-maxage=30 \\</span><br><span class="line">--audit-log-maxbackup=3 \\</span><br><span class="line">--audit-log-maxsize=100 \\</span><br><span class="line">--audit-log-truncate-enabled=true \\</span><br><span class="line">--audit-log-path=/var/log/kubernetes/k8s-audit.log&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl restart kube-apiserver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 k8s-master]# cat controller-manager.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">MASTER_ADDRESS=$&#123;1:-&quot;127.0.0.1&quot;&#125;</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line"></span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--master=$&#123;MASTER_ADDRESS&#125;:8080 \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--bind-address=0.0.0.0 \\</span><br><span class="line">--service-cluster-ip-range=10.10.0.0/16 \\</span><br><span class="line">--cluster-name=kubernetes \\</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--experimental-cluster-signing-duration=87600h0m0s \\</span><br><span class="line">--feature-gates=RotateKubeletServerCertificate=true \\</span><br><span class="line">--feature-gates=RotateKubeletClientCertificate=true \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=10.20.0.0/16 \\</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl restart kube-controller-manager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 k8s-master]# cat scheduler.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">MASTER_ADDRESS=$&#123;1:-&quot;127.0.0.1&quot;&#125;</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--master=$&#123;MASTER_ADDRESS&#125;:8080 \\</span><br><span class="line">--address=0.0.0.0 \\</span><br><span class="line">--leader-elect&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/usr/lib/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl restart kube-scheduler</span><br><span class="line"></span><br><span class="line">#分发token.csv,依次在master01 master02 master03执行相应的脚本</span><br><span class="line">#master01</span><br><span class="line">./apiserver.sh 192.168.1.101 https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 ./controller-manager.sh 127.0.0.1</span><br><span class="line">./scheduler.sh 127.0.0.1</span><br><span class="line"></span><br><span class="line">#master02</span><br><span class="line">./apiserver.sh 192.168.1.102 https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 ./controller-manager.sh 127.0.0.1</span><br><span class="line">./scheduler.sh 127.0.0.1</span><br><span class="line"></span><br><span class="line">#master03</span><br><span class="line">./apiserver.sh 192.168.1.103 https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 ./controller-manager.sh 127.0.0.1</span><br><span class="line">./scheduler.sh 127.0.0.1</span><br><span class="line"></span><br><span class="line">[root@master01 k8s-master]# ps -ef | grep kube</span><br><span class="line">root      4148     1  3 17:50 ?        00:01:24 /opt/kubernetes/bin/etcd --config-file=/opt/kubernetes/cfg/etcd.yml</span><br><span class="line">root      4174     1  3 17:50 ?        00:01:22 /opt/kubernetes/bin/kube-apiserver --logtostderr=false --v=2 --log-dir=/var/log/kubernetes --etcd-servers=https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 --bind-address=0.0.0.0 --secure-port=6443 --advertise-address=192.168.1.101 --allow-privileged=true --service-cluster-ip-range=10.10.0.0/16 --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction --authorization-mode=RBAC,Node --kubelet-https=true --enable-bootstrap-token-auth=true --token-auth-file=/opt/kubernetes/cfg/token.csv --service-node-port-range=30000-50000 --kubelet-client-certificate=/optkubernetes/ssl/server.pem --kubelet-client-key=/opt/kubernetes/ssl/server.pem --tls-cert-file=/opt/kubernetes/ssl/server.pem --tls-private-key-file=/opt/kubernetes/ssl/server-key.pem --client-ca-file=/opt/kubernetes/ssl/ca.pem --service-account-key-file=/opt/kubernetes/ssl/ca-key.pem --etcd-cafile=/opt/kubernetes/ssl/ca.pem --etcd-certfile=/opt/kubernetes/ssl/server.pem --etcd-keyfile=/optkubernetes/ssl/server-key.pem --requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --proxy-client-cert-file=/opt/kubernetes/ssl/metrics-server.pem --proxy-client-key-file=/opt/kubernetes/ssl/metrics-server-key.pem --runtime-config=api/all=true --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-truncate-enabled=true --audit-log-path=/var/logkubernetes/k8s-audit.log</span><br><span class="line">root      4281     1  0 17:52 ?        00:00:04 /opt/kubernetes/bin/kube-controller-manager --logtostderr=true --v=2 --master=127.0.0.1:8080 --leader-elect=true --bind-address=0.0.0.0 --service-cluster-ip-range=10.10.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem --cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem --service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem --experimental-cluster-signing-duration=87600h0m0s --feature-gates=RotateKubeletServerCertificate=true --feature-gates=RotateKubeletClientCertificate=true --allocate-node-cidrs=true --cluster-cidr=10.20.0.0/16 --root-ca-file=/opt/kubernetes/ssl/ca.pem</span><br><span class="line">root      4302     1  0 17:52 ?        00:00:05 /opt/kubernetes/bin/kube-scheduler --logtostderr=true --v=2 --master=127.0.0.1:8080 --address=0.0.0.0 --leader-elect</span><br><span class="line"></span><br><span class="line">#查看写入etcd内容，用于排查错误</span><br><span class="line">/opt/kubernetes/bin/etcdctl --cacert=/opt/kubernetes/ssl/ca.pem --cert=/opt/kubernetes/ssl/server.pem --key=/opt/kubernetes/ssl/server-key.pem --endpoints=https://192.168.1.101:2379,https://192.168.1.102:2379,https://192.168.1.103:2379 get /registry/ --prefix --keys-only</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 k8s-master]# kubectl  get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line"></span><br><span class="line">[root@master01 k8s-master]# kubectl cluster-info</span><br><span class="line">Kubernetes master is running at http://localhost:8080</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use &apos;kubectl cluster-info dump&apos;.</span><br></pre></td></tr></table></figure></p>
<h5 id="nginx相关配置"><a href="#nginx相关配置" class="headerlink" title="nginx相关配置"></a>nginx相关配置</h5><p>开启tcp代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">stream&#123;</span><br><span class="line">log_format proxy &apos;$remote_addr [$time_local] &apos;</span><br><span class="line">                     &apos;$protocol $status $bytes_sent $bytes_received &apos;</span><br><span class="line">                     &apos;$session_time &quot;$upstream_addr&quot; &apos;</span><br><span class="line">                     &apos;&quot;$upstream_bytes_sent&quot; &quot;$upstream_bytes_received&quot; &quot;$upstream_connect_time&quot;&apos;;</span><br><span class="line">upstream k8s-apiserver &#123;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server 192.168.1.101:6443;</span><br><span class="line">        server 192.168.1.102:6443;</span><br><span class="line">        server 192.168.1.103:6443;</span><br><span class="line">       &#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 6443;</span><br><span class="line">        proxy_pass k8s-apiserver;                                                       </span><br><span class="line">        access_log logs/apiserver.log proxy;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="kubelet证书自动续期和创建Node授权用户"><a href="#kubelet证书自动续期和创建Node授权用户" class="headerlink" title="kubelet证书自动续期和创建Node授权用户"></a>kubelet证书自动续期和创建Node授权用户</h5><p>Node节点 授权用户 kubelet-bootstrap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding  kubelet-bootstrap --clusterrole=system:node-bootstrapper  --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure></p>
<p>具有自动批准 selfnodeserver 类型 CSR 请求的能力<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 kubelet-certificate-rotating]# cat tls-instructs-csr.yaml </span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata: </span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;certificates.k8s.io&quot;]</span><br><span class="line">  resources: [&quot;certificatesigningrequests/selfnodeserver&quot;]</span><br><span class="line">  verbs: [&quot;create&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl apply -f tls-instructs-csr.yaml</span><br><span class="line"></span><br><span class="line">#自动批准 kubelet-bootstrap 用户 TLS bootstrapping 首次申请证书的 CSR 请求</span><br><span class="line">kubectl create clusterrolebinding node-client-auto-approve-csr --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --user=kubelet-bootstrap</span><br><span class="line"></span><br><span class="line">#自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</span><br><span class="line">kubectl create clusterrolebinding node-client-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group=system:nodes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#自动批准 system:nodes 组用户更新 kubelet 10250 api 端口证书的 CSR 请求</span><br><span class="line">kubectl create clusterrolebinding node-server-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver --group=system:nodes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master01 kubelet-certificate-rotating]# kubectl get clusterrolebinding|egrep &quot;node-(.*)-auto&quot;</span><br><span class="line">node-client-auto-approve-csr                           ClusterRole/system:certificates.k8s.io:certificatesigningrequests:nodeclient       2m4s</span><br><span class="line">node-client-auto-renew-crt                             ClusterRole/system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   109s</span><br><span class="line">node-server-auto-renew-crt                             ClusterRole/system:certificates.k8s.io:certificatesigningrequests:selfnodeserver   93s</span><br></pre></td></tr></table></figure></p>
<h5 id="配置Node组件并运行"><a href="#配置Node组件并运行" class="headerlink" title="配置Node组件并运行"></a>配置Node组件并运行</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/k8s-node</span><br><span class="line">cd /data/k8s-node/</span><br><span class="line"></span><br><span class="line">[root@node01 k8s-node]# cat kubelet.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">#create static pod directory</span><br><span class="line">mkdir -p /etc/kubernetes/manifests</span><br><span class="line"></span><br><span class="line">DNS_SERVER_IP=$&#123;1:-&quot;10.10.0.2&quot;&#125;</span><br><span class="line">HOSTNAME=$&#123;2:-&quot;`hostname`&quot;&#125;</span><br><span class="line">CLUETERDOMAIN=$&#123;3:-&quot;cluster.local&quot;&#125;</span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--hostname-override=$&#123;HOSTNAME&#125; \\</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \\</span><br><span class="line">--network-plugin=cni \\</span><br><span class="line">--cni-conf-dir=/etc/cni/net.d \\</span><br><span class="line">--cni-bin-dir=/opt/cni/bin \\</span><br><span class="line">--pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.2&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/kubelet-config.yml</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/ssl/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 0s</span><br><span class="line">    cacheUnauthorizedTTL: 0s</span><br><span class="line">clusterDNS:</span><br><span class="line">- $&#123;DNS_SERVER_IP&#125;</span><br><span class="line">clusterDomain: $&#123;CLUETERDOMAIN&#125;</span><br><span class="line">cpuManagerReconcilePeriod: 0s</span><br><span class="line">evictionPressureTransitionPeriod: 0s</span><br><span class="line">fileCheckFrequency: 0s</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 0s</span><br><span class="line">imageMinimumGCAge: 0s</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">nodeStatusReportFrequency: 0s</span><br><span class="line">nodeStatusUpdateFrequency: 0s</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 0s</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 0s</span><br><span class="line">syncFrequency: 0s</span><br><span class="line">volumeStatsAggPeriod: 0s</span><br><span class="line">featureGates: </span><br><span class="line">  RotateKubeletServerCertificate: true</span><br><span class="line">  RotateKubeletClientCertificate: true</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line">RestartSec=10</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kubelet</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node01 k8s-node]# cat proxy.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">HOSTNAME=$&#123;1:-&quot;`hostname`&quot;&#125;</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=true \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 0</span><br><span class="line">  contentType: &quot;&quot;</span><br><span class="line">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line">  qps: 0</span><br><span class="line">clusterCIDR: 10.20.0.0/16</span><br><span class="line">configSyncPeriod: 0s</span><br><span class="line">conntrack:</span><br><span class="line">  maxPerCore: null</span><br><span class="line">  min: null</span><br><span class="line">  tcpCloseWaitTimeout: null</span><br><span class="line">  tcpEstablishedTimeout: null</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: &quot;&quot;</span><br><span class="line">hostnameOverride: $&#123;HOSTNAME&#125;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;&quot;</span><br><span class="line">  strictARP: false</span><br><span class="line">  syncPeriod: 0s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: &quot;&quot;</span><br><span class="line">mode: &quot;ipvs&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: null</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 0s</span><br><span class="line">winkernel:</span><br><span class="line">  enableDSR: false</span><br><span class="line">  networkName: &quot;&quot;</span><br><span class="line">  sourceVip: &quot;&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/usr/lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-proxy</span><br><span class="line">systemctl restart kube-proxy</span><br><span class="line"></span><br><span class="line">#node01</span><br><span class="line">./kubelet.sh 10.10.0.2 node01 cluster.local</span><br><span class="line">./proxy.sh </span><br><span class="line">#node02</span><br><span class="line">./kubelet.sh 10.10.0.2 node02 cluster.local</span><br><span class="line">./proxy.sh </span><br><span class="line">#node03</span><br><span class="line">./kubelet.sh 10.10.0.2 node03 cluster.local</span><br><span class="line">./proxy.sh </span><br><span class="line"></span><br><span class="line">#在任意master查看</span><br><span class="line">[root@master01 k8s-node]# kubectl get node</span><br><span class="line">NAME     STATUS     ROLES    AGE   VERSION</span><br><span class="line">node01   NotReady   &lt;none&gt;   13h   v1.18.6</span><br><span class="line">node02   NotReady   &lt;none&gt;   27m   v1.18.6</span><br><span class="line">node03   NotReady   &lt;none&gt;   27m   v1.18.6</span><br></pre></td></tr></table></figure>
<p>节点处理 NoReady 状态，是因为目前还没有安装网络组件</p>
<p>解决无法查询pods日志问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 yaml]# cat rbac/apiserver-to-kubelet-rbac.yml </span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kubelet-api-admin</span><br><span class="line">subjects: </span><br><span class="line">- kind: User</span><br><span class="line">  name: kubernetes</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kubelet-api-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">kubectl apply -f ~/yaml/rbac/apiserver-to-kubelet-rbac.yml</span><br></pre></td></tr></table></figure></p>
<p> RBAC DENY解决办法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">I0905 16:15:47.988359   22403 rbac.go:119] RBAC DENY: user &quot;system:node:node01&quot; groups [&quot;system:nodes&quot; &quot;system:authenticated&quot;] cannot &quot;update&quot; resource &quot;leases.coordination.k8s.io&quot; named &quot;node01&quot; in namespace &quot;kube-node-lease&quot;</span><br><span class="line">解决方法1</span><br><span class="line">[root@master01 kubernetes]# kubectl describe clusterrolebindings system:node  </span><br><span class="line">Name:         system:node</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: true</span><br><span class="line">Role:</span><br><span class="line">  Kind:  ClusterRole</span><br><span class="line">  Name:  system:node</span><br><span class="line">Subjects:</span><br><span class="line">  Kind  Name  Namespace</span><br><span class="line">  ----  ----  ---------</span><br><span class="line"></span><br><span class="line">[root@master01 metrics]# kubectl create clusterrolebinding kubelet-node-clusterbinding --clusterrole=system:node --group=system:nodes  </span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubelet-node-clusterbinding created</span><br><span class="line">[root@master01 metrics]# kubectl describe clusterrolebindings kubelet-node-clusterbinding  </span><br><span class="line">Name:         kubelet-node-clusterbinding</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Role:</span><br><span class="line">  Kind:  ClusterRole</span><br><span class="line">  Name:  system:node</span><br><span class="line">Subjects:</span><br><span class="line">  Kind   Name          Namespace</span><br><span class="line">  ----   ----          ---------</span><br><span class="line">  Group  system:nodes  </span><br><span class="line"></span><br><span class="line">解决方法2</span><br><span class="line">参考[这里](https://github.com/kubernetes/kubernetes/issues/61511)</span><br><span class="line">Ensure Node authorization comes first in the authorizer mode arguments:</span><br><span class="line"></span><br><span class="line">--authorization-mode=Node,RBAC</span><br><span class="line"></span><br><span class="line">If you reverse those, RBAC will attempt to authorize, fail and log, then the Node authorizer will succeed. The RBAC message is harmless in this case, but is annoying.</span><br><span class="line"></span><br><span class="line">Don&apos;t grant the system:node role to the system:nodes group or you will undo the protection of the Node authorizer.</span><br></pre></td></tr></table></figure></p>
<h5 id="kubernetes启用ipvs-在所有节点执行"><a href="#kubernetes启用ipvs-在所有节点执行" class="headerlink" title="kubernetes启用ipvs,在所有节点执行"></a>kubernetes启用ipvs,在所有节点执行</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm</span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF&gt;/etc/sysconfig/modules/ipvs.modules </span><br><span class="line">#!/bin/bash</span><br><span class="line">ipvs_modules_dir=&quot;/usr/lib/modules/\`uname -r\`/kernel/net/netfilter/ipvs&quot;</span><br><span class="line">for i in \`ls \$ipvs_modules_dir | sed  -r &apos;s#(.*).ko.xz#\1#&apos;\`; do</span><br><span class="line">    /sbin/modinfo -F filename \$i  &amp;&gt; /dev/null</span><br><span class="line">    if [ \$? -eq 0 ]; then</span><br><span class="line">        /sbin/modprobe \$i</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x /etc/sysconfig/modules/ipvs.modules </span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules</span><br></pre></td></tr></table></figure>
<h5 id="网络部署-Flannel-amp-amp-calico-任选其一"><a href="#网络部署-Flannel-amp-amp-calico-任选其一" class="headerlink" title="网络部署,(Flannel &amp;&amp; calico)任选其一"></a>网络部署,(Flannel &amp;&amp; calico)任选其一</h5><p>Calico网络方式</p>
<ul>
<li>IPIP<br>是把一个IP数据包又套在一个IP包里，即把 IP 层封装到 IP 层的一个 tunnel,作用其实基本上就相当于一个基于IP层的网桥！一般来说，普通的网桥是基于mac层的，根本不需 IP，而这个 ipip 则是通过两端的路由做一个 tunnel，把两个本来不通的网络通过点对点连接起来。ipip 的源代码在内核 net/ipv4/ipip.c 中可以找到</li>
<li>BGP<br>边界网关协议（Border Gateway Protocol, BGP）是互联网上一个核心的去中心化自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。BGP不使用传统的内部网关协议（IGP）的指标，而使用基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议。BGP，通俗的讲就是讲接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP，BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统</li>
</ul>
<p>Calico 的核心组件：</p>
<ul>
<li>Felix，Calico agent，跑在每台需要运行 workload 的节点上，主要负责配置路由及 ACLs 等信息来确保 endpoint 的连通状态；</li>
<li>etcd，分布式键值存储，主要负责网络元数据一致性，确保 Calico 网络状态的准确性；</li>
<li>BGP Client(BIRD), 主要负责把 Felix 写入 kernel 的路由信息分发到当前 Calico 网络，确保 workload 间的通信的有效性；</li>
</ul>
<p>BGP Route Reflector(BIRD), 大规模部署时使用，摒弃所有节点互联的 mesh 模式，通过一个或者多个BGP Route Reflector来完成集中式的路由分发；<br>通过将整个互联网的可扩展 IP 网络原则压缩到数据中心级别，Calico 在每一个计算节点利用Linux kernel实现了一个高效的vRouter来负责数据转发而每个vRouter通过BGP<br>协议负责把自己上运行的 workload 的路由信息像整个 Calico 网络内传播 － 小规模部署可以直接互联，大规模下可通过指定的<br>BGP route reflector 来完成。这样保证最终所有的 workload 之间的数据流量都是通过 IP 包的方式完成互联的。</p>
<p>当容器创建时，calico为容器生成veth pair，一端作为容器网卡加入到容器的网络命名空间，并设置IP和掩码，一端直接暴露在宿主机上，<br>并通过设置路由规则，将容器IP暴露到宿主机的通信路由上。于此同时，calico为每个主机分配了一段子网作为容器可分配的IP范围，这样就可以根据子网的<br>CIDR为每个主机生成比较固定的路由规则。<br>当容器需要跨主机通信时，主要经过下面的简单步骤：<br>1）容器流量通过veth pair到达宿主机的网络命名空间上。<br>2）根据容器要访问的IP所在的子网CIDR和主机上的路由规则，找到下一跳要到达的宿主机IP。<br>3）流量到达下一跳的宿主机后，根据当前宿主机上的路由规则，直接到达对端容器的veth pair插在宿主机的一端，最终进入容器。</p>
<p>从上面的通信过程来看，跨主机通信时，整个通信路径完全没有使用NAT或者UDP封装，性能上的损耗确实比较低。但正式由于calico的通信机制是完全基于三层的，这种机制也带来了一些缺陷，例如：<br>1）calico目前只支持TCP、UDP、ICMP、ICMPv6协议，如果使用其他四层协议（例如NetBIOS协议），建议使用weave、原生overlay等其他overlay网络实现<br>2）基于三层实现通信，在二层上没有任何加密包装，因此只能在私有的可靠网络上使用。<br>3）流量隔离基于iptables实现，并且从etcd中获取需要生成的隔离规则，有一些性能上的隐患</p>
<p>calico/nodedocker容器运行在k8s的master和每个node节点上。由于它包含用于calico路由的BGPagent<br>calico-cni插件与kubelet组件一起部署在每个node节点上，用于当pod创建后，添加该pod到calico网路<br>calico/kube-policy-controller运行在k8s的pod里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">配置NetworkManager</span><br><span class="line">NetworkManager管理默认网络命名空间中接口的路由表的功能，可能会干扰Calico正确处理网络路由的能力。</span><br><span class="line">创建一个配置文件/etc/NetworkManager/conf.d/calico.conf，来制止这种干扰：</span><br><span class="line">[keyfile]</span><br><span class="line">unmanaged-devices=interface-name:cali*;interface-name:tunl*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#node上执行</span><br><span class="line">mkdir /opt/cni/bin /etc/cni/net.d -p</span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz</span><br><span class="line">tar xvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin/</span><br><span class="line"></span><br><span class="line">#以下在master01上执行</span><br><span class="line">mkdir -p ~/yaml/calico$ cd ~/yaml/calico</span><br><span class="line"># 注意：下面是基于自建etcd做为存储的配置文件</span><br><span class="line">curl https://docs.projectcalico.org/manifests/calico-etcd.yaml -O</span><br></pre></td></tr></table></figure>
<p>calico-etcd.yaml需要修改如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#Secret 配置修改</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secrettype: Opaque</span><br><span class="line">metadata:  </span><br><span class="line">  name: calico-etcd-secrets</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:  </span><br><span class="line">  etcd-key: (cat /opt/kubernetes/ssl/server-key.pem | base64 -w 0) # 将输出结果填写在这里</span><br><span class="line">  etcd-cert: (cat /opt/kubernetes/ssl/server.pem | base64 -w 0) # 将输出结果填写在这里</span><br><span class="line">  etcd-ca: (cat /opt/kubernetes/ssl/ca.pem | base64 -w 0) # 将输出结果填写在这里</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ConfigMap 配置修改</span><br><span class="line"># You must also populate the Secret below with these files.</span><br><span class="line">etcd_ca: &quot;/calico-secrets/etcd-ca&quot;</span><br><span class="line">etcd_cert: &quot;/calico-secrets/etcd-cert&quot;</span><br><span class="line">etcd_key: &quot;/calico-secrets/etcd-key</span><br><span class="line"></span><br><span class="line">#配置网卡自动发现规则</span><br><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;interface=eth.*&quot;</span><br><span class="line">- name: IP6_AUTODETECTION_METHOD</span><br><span class="line">  value: &quot;interface=eth.*&quot;</span><br><span class="line">- name: KUBERNETES_SERVICE_HOST</span><br><span class="line">  value: &quot;lb.abc.com.cn&quot;</span><br><span class="line">- name: KUBERNETES_SERVICE_PORT</span><br><span class="line">  value: &quot;6443&quot;</span><br><span class="line">- name: KUBERNETES_SERVICE_PORT_HTTPS</span><br><span class="line">  value: &quot;6443&quot;</span><br><span class="line"></span><br><span class="line">#检查Calico 模式设置，默认为ipip</span><br><span class="line">- name: CALICO_IPV4POOL_IPIP</span><br><span class="line">　value: &quot;Always</span><br><span class="line"></span><br><span class="line">[root@master01 calico]# kubectl apply -f calico-etcd.yaml</span><br><span class="line">secret/calico-etcd-secrets created</span><br><span class="line">configmap/calico-config created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">daemonset.apps/calico-node created</span><br><span class="line">serviceaccount/calico-node created</span><br><span class="line">deployment.apps/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br><span class="line"></span><br><span class="line">#这里需要注意,如果calico-kube-controllers报如下错误，需要在service里env添加KUBERNETES_SERVICE_HOST和KUBERNETES_SERVICE_PORT环境变量</span><br><span class="line"></span><br><span class="line">E0820 02:39:51.732885       1 reflector.go:153] pkg/mod/k8s.io/client-go@v0.17.2/tools/cache/reflector.go:105: Failed to list *v1.ServiceAccount: Get https://10.10.0.1:443/api/v1/serviceaccounts?limit=500&amp;resourceVersion=0: dial tcp 10.10.0.1:443: i/o timeout</span><br><span class="line"></span><br><span class="line">此外，这里也和网络插件选择有关系，如果选择的是flannel默认工作方式，工作是正常的.如果选择的是calico的ipip模式，需要在calico　init环境里添加KUBERNETES_SERVICE_HOST和KUBERNETES_SERVICE_PORT环境变量，否则在添加pod时候会提示无法连接apiserver.</span><br><span class="line">网络结构方面的因素:本文的测试环境为master和node不在同一个机器，用nginx负载均衡给后边三台主机，nginx未在三台master上，所以才需要calico　init添加相关环境变量。</span><br><span class="line"></span><br><span class="line">[root@master01 calico]# kubectl  get pods -n kube-system  | grep calico</span><br><span class="line">calico-kube-controllers-cdd76d5d-qh8lj   1/1     Running   0          51s</span><br><span class="line">calico-node-8qntz                        1/1     Running   0          51s</span><br><span class="line">calico-node-c7d5k                        1/1     Running   0          51s</span><br><span class="line">calico-node-xrxb5                        1/1     Running   0          51s</span><br><span class="line"></span><br><span class="line">[root@master01 calico]# kubectl get node</span><br><span class="line">NAME     STATUS   ROLES    AGE    VERSION</span><br><span class="line">node01   Ready    &lt;none&gt;   18h    v1.18.6</span><br><span class="line">node02   Ready    &lt;none&gt;   6h7m   v1.18.6</span><br><span class="line">node03   Ready    &lt;none&gt;   6h7m   v1.18.6</span><br></pre></td></tr></table></figure></p>
<p>Calico 管理工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">wget wget -O /usr/local/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.14.2/calicoctl</span><br><span class="line">chmod +x /usr/local/bin/calicoctl</span><br><span class="line"></span><br><span class="line">[root@node01 ~]# calicoctl node status</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">|  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.1.104 | node-to-node mesh | up    | 10:27:12 | Established |</span><br><span class="line">| 192.168.1.105 | node-to-node mesh | up    | 10:27:13 | Established |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br></pre></td></tr></table></figure></p>
<p>如果是用flannel，参考如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">添加环境变量和修改Network为kube-control-manager里cluster-cidr一致</span><br><span class="line">- name: KUBERNETES_SERVICE_HOST</span><br><span class="line">  value: lb.abc.com.cn</span><br><span class="line">- name: KUBERNETES_SERVICE_PORT</span><br><span class="line">  value: &quot;6443&quot;</span><br><span class="line"></span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Network&quot;: &quot;10.20.0.0/16&quot;,</span><br><span class="line">      &quot;Backend&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">kubectl apply -f kube-flannel.yml </span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure></p>
<h5 id="CoreDNS部署"><a href="#CoreDNS部署" class="headerlink" title="CoreDNS部署"></a>CoreDNS部署</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">yum install jq -y</span><br><span class="line">cd ~/yaml</span><br><span class="line">mkdir coredns</span><br><span class="line">cd coredns</span><br><span class="line">wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed</span><br><span class="line">wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/deploy.sh</span><br><span class="line">chmod +x deploy.sh</span><br><span class="line">#默认情况下 CLUSTER_DNS_IP 是自动获取kube-dns的集群ip的，但是由于没有部署kube-dns所以只能手动指定一个集群ip</span><br><span class="line">./deploy.sh -i 10.10.0.2 &gt; coredns.yml</span><br><span class="line">kubectl apply -f coredns.yml</span><br><span class="line">kubectl get pods --namespace kube-system</span><br><span class="line">kubectl get svc --namespace kube-system</span><br><span class="line"></span><br><span class="line">#测试 Coredns 解析</span><br><span class="line">[root@master01 coredns]# cat busybox.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:1.28.4</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line"></span><br><span class="line">[root@master01 coredns]# kubectl apply -f busybox.yml </span><br><span class="line">[root@master01 coredns]# kubectl exec -i busybox -n default nslookup kubernetes</span><br><span class="line">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.</span><br><span class="line">Server:    10.10.0.2</span><br><span class="line">Address 1: 10.10.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.10.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>
<h5 id="验证集群状态"><a href="#验证集群状态" class="headerlink" title="验证集群状态"></a>验证集群状态</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#打node 或者master 节点的标签</span><br><span class="line">kubectl label node 192.168.1.101  node-role.kubernetes.io/master=&apos;master&apos;</span><br><span class="line">kubectl label node 192.168.1.104  node-role.kubernetes.io/node=&apos;node&apos;</span><br><span class="line">kubectl label node 192.168.1.105  node-role.kubernetes.io/node=&apos;node&apos;</span><br><span class="line">kubectl label node 192.168.1.106  node-role.kubernetes.io/node=&apos;node&apos;</span><br><span class="line"></span><br><span class="line">kubectl get node,cs</span><br></pre></td></tr></table></figure>
<h5 id="metrics遇到的问题"><a href="#metrics遇到的问题" class="headerlink" title="metrics遇到的问题"></a>metrics遇到的问题</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">E0904 14:56:32.791786     852 available_controller.go:420] v1beta1.metrics.k8s.io failed with: failing or missing response from https://10.10.22.87:443/apis/metrics.k8s.io/v1beta1: bad status from https://10.10.22.87:443/apis/metrics.k8s.io/v1beta1: 403</span><br><span class="line"></span><br><span class="line">解决有两个方式:</span><br><span class="line">1.给system:annonymous权限</span><br><span class="line">kubectl create clusterrolebinding system:anonymous   --clusterrole=cluster-admin   --user=system:anonymous</span><br><span class="line"></span><br><span class="line">2.创建system:metrics-server角色并授权,参考[官网文档](https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/)</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /opt/kubernetes/ssl/front-proxy-ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca</span><br><span class="line"></span><br><span class="line">cat front-proxy-client-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;front-proxy-client&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfssl gencert   -ca=front-proxy-ca.pem  -ca-key=front-proxy-ca-key.pem -config=ca-config.json   -profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare front-proxy-client</span><br><span class="line"></span><br><span class="line">kube-apiserver添加如下参数，重启服务</span><br><span class="line">--proxy-client-cert-file=/opt/kubernetes/ssl/front-proxy-client.pem \</span><br><span class="line">--proxy-client-key-file=/opt/kubernetes/ssl/front-proxy-client-key.pem \</span><br><span class="line">--requestheader-allowed-names=front-proxy-client \</span><br><span class="line">--requestheader-client-ca-file=/opt/kubernetes/ssl/front-proxy-ca.pem \</span><br><span class="line">--requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">--requestheader-group-headers=X-Remote-Group \</span><br><span class="line">--requestheader-username-headers=X-Remote-User \</span><br><span class="line">--runtime-config=api/all=true&quot;</span><br><span class="line"></span><br><span class="line">重启服务后通过一下命令查看配置是否生成相应configmap</span><br><span class="line">kubectl get configmap extension-apiserver-authentication -nkube-system -o yaml</span><br></pre></td></tr></table></figure>
<p>[ref]<br><a href="https://www.cnblogs.com/centos-python/articles/13168559.html" target="_blank" rel="noopener">Kubelet 证书如何自动续期</a><br><a href="https://www.cnblogs.com/ainimore/p/12972858.html" target="_blank" rel="noopener">kubelet 证书自动续期</a><br><a href="https://blog.51cto.com/14143894/2483207" target="_blank" rel="noopener">k8s高可用二进制部署使用Calico网络方案</a><br><a href="https://juejin.im/post/6844904163785211911#heading-21" target="_blank" rel="noopener">Kubernetes v1.18.2 二进制高可用部署</a><br><a href="https://my.oschina.net/xueyi28/blog/3071431" target="_blank" rel="noopener">calico网络原理、组网方式和使用</a><br><a href="https://www.cnblogs.com/zerchin/p/CentOS7_kernel_update.html" target="_blank" rel="noopener">CentOS7升级系统内核至4.4.xx版本</a><br><a href="https://juejin.im/entry/6844903613332996110" target="_blank" rel="noopener">kubernetes实验:k8s与各网络插件集成</a><br><a href="https://blog.fanfengqiang.com/2019/07/27/kubernetes%E7%8E%AF%E5%A2%83%E4%B8%ADflannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E7%9A%84DNS%E4%B8%8Ehosts%E6%96%87%E4%BB%B6%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">kubernetes环境中flannel网络插件的DNS与hosts文件的优先级问题</a><br><a href="https://juejin.im/entry/6844903665879220231" target="_blank" rel="noopener">Kubernetes DNS 高阶指南</a><br><a href="https://stackoverflow.com/questions/58194119/kubeadm-failed-to-create-subnetmanager-error-retrieving-pod-spec-for-kube-syste" target="_blank" rel="noopener">Kubeadm Failed to create SubnetManager: error retrieving pod spec for kube-system</a><br><a href="https://blog.51cto.com/foxhound/2121569" target="_blank" rel="noopener">RBAC DENY 解决办法</a><br><a href="https://xigang.github.io/2019/03/15/metrics-servere/" target="_blank" rel="noopener">Kubernetes Metrics-Server介绍及源码分析</a><br><a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/eks-metrics-server/" target="_blank" rel="noopener">为什么我无法在 Amazon EKS 中使用 Metrics Server 从容器、pod 或节点收集指标？</a><br><a href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/02/28/kubernetes-node-cannot-access-service.html" target="_blank" rel="noopener">Kubernetes集群node无法访问service：kube-proxy没有正确设置cluster-cidr</a></p>
<hr>

							<!-- 支付宝打赏图案 -->
      						<!--
      						<div id="donate_guide" class="donate_bar center ">
          					<a href="http://mypay-1253516637.costj.myqcloud.com/2000.jpg" title="支付宝打赏" class="fancybox" rel="article0"       style="float:left;margin-left:25%;margin-right:2px;">
          					<img src="http://mypay-1253516637.costj.myqcloud.com/2000.jpg" title="支付宝打赏" height="164px" width="164px">
          					</a> 
      						</div>
      						-->
					</div>

			  <!-- about -->
			  
		</div>

		<!-- pagination -->
	  
	  
	    
		<!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" data-uid="MTAyMC8zOTQ5MS8xNjAxOA==">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->
		
<!--		<div class="comment-section">
  
  


</div> -->
	</div>

	

</div>


		<footer>
			


<p>
  由 <a href="https://hexo.io">hexo</a> 强力驱动 |&nbsp;&nbsp;本站总点击 <span id="busuanzi_value_site_pv"></span> 次
&nbsp;&nbsp;|&nbsp;&nbsp;您是第 <span id="busuanzi_value_site_uv"></span> 位访客
</p>
<p>
  &copy; 2023 <a href="https://t1ger.github.io"> t1ger </a>
  &nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/baidusitemap.xml">百度网站地图</a></span>

</p>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99921399-1', 'auto');
  ga('send', 'pageview');

</script>
		</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
